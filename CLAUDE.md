Subtasks Feature - Implementation Plan

 Overview

 Add single-level subtasks to tasks. Subtasks are full tasks with their own status (from board's status options),
 due dates, assignees, and sections. They appear as expandable indented cards in kanban/swimlane/table views,
 have a dedicated "Subtasks" tab in the TaskModal, and show in "My Tasks" with parent context.

 Design Decisions:
 - Single-level nesting only (subtasks cannot have sub-subtasks, enforced server-side)
 - Full board status options on subtasks (not just done/not-done)
 - Subtasks inherit boardId from parent, share status/section options
 - Independent due dates, assignees, sections per subtask
 - Cascade delete (deleting parent deletes all subtasks)
 - Subtasks appear in "My Tasks" with "subtask of: Parent Name" label
 - Expanded view: full indented cards below parent in kanban/swimlane columns
 - Subtask cards NOT draggable in v1 (no DnD)
 - No auto-complete parent when all subtasks done (just show progress indicator)

 ---
 New Files (4)

 1. src/components/tasks/SubtaskIndicator.tsx

 Small reusable component showing subtask progress on task cards.
 - Props: subtaskCount, subtaskCompletedCount, isExpanded?, onToggle?
 - Renders: ListTree icon + "2/5" text (completed/total)
 - If onToggle provided: clickable chevron for expand/collapse
 - Styling: text-xs text-muted-foreground (matches TaskActivityIndicators)

 2. src/components/tasks/ExpandedSubtasks.tsx

 Renders subtask cards inline below a parent task in board views.
 - Props: parentTaskId, onTaskClick, variant ('kanban' | 'swimlane')
 - Uses useSubtasks(parentTaskId) to fetch subtasks
 - Renders simplified cards with ml-6 border-l-2 border-primary/20 indentation
 - Each card: status dot, title, assignee avatars, due date
 - Cards clickable (open TaskModal) but NOT draggable
 - Loading skeleton while fetching

 3. src/components/tasks/SubtasksTab.tsx

 Full subtask management panel for the TaskModal.
 - Props: parentTaskId, boardId, statusOptions, sectionOptions, assignableUsers
 - Progress bar at top: colored bar showing completed/total ratio
 - Subtask list: each row has status dropdown, title (click to open), assignee avatars,
   due date, delete button on hover
 - Add subtask form at bottom: title input, status dropdown (default: first status),
   optional assignee/date pickers, Add button / Enter to submit
 - Uses: useSubtasks, useCreateSubtask, useUpdateTask, useDeleteTask

 4. Migration file in drizzle/

 Generated by drizzle-kit. Adds parent_task_id column with FK + partial index.

 ---
 Modified Files (14)

 1. src/lib/db/schema/tasks.ts

 - Add parentTaskId column to tasks table:
   parentTaskId: uuid('parent_task_id').references(() => tasks.id, { onDelete: 'cascade' })
 - Add self-referential relations to tasksRelations:
   parentTask: one(tasks, { fields: [tasks.parentTaskId], references: [tasks.id], relationName: 'subtasks' })
   subtasks: many(tasks, { relationName: 'subtasks' })

 2. src/lib/actions/tasks.ts

 Interface changes:
 - TaskWithAssignees: add parentTaskId (string|null), subtaskCount (number), subtaskCompletedCount (number)
 - CreateTaskInput: add parentTaskId? (string)
 - MyTaskWithContext: add parentTask? ({ id, title } | null)
 - SearchResult: add parentTaskId (string|null), parentTaskTitle (string|null)

 Function changes:
 - listTasks: add isNull(tasks.parentTaskId) filter, batch-query subtask counts per parent
 - NEW listSubtasks(parentTaskId): verify access, query subtasks ordered by position, return TaskWithAssignees[]
 - createTask: when parentTaskId provided, validate parent exists + is not a subtask,
   inherit boardId, scope position to siblings
 - getTask: include parentTaskId + subtask counts in response
 - listMyTasks: include subtasks with parentTask context { id, title }
 - searchTasks: include subtasks with parentTaskId + parentTaskTitle

 3. src/lib/hooks/useTasks.ts

 - Add query key: taskKeys.subtasks(parentTaskId)
 - New useSubtasks(parentTaskId, options?) hook wrapping listSubtasks
 - New useCreateSubtask(parentTaskId, boardId) mutation:
   calls createTask with parentTaskId, invalidates subtask list + parent lists + parent detail
 - Update useUpdateTask onSettled: also invalidate subtask caches (status changes affect completed count)
 - Update useDeleteTask onSettled: also invalidate subtask caches

 4. src/lib/hooks/index.ts

 - Export useSubtasks, useCreateSubtask

 5. src/components/tasks/KanbanTaskCard.tsx

 - Add SubtaskIndicator in meta row (line 69), between date and activity indicators
 - Add onToggleSubtasks? and isExpanded? props, pass to SubtaskIndicator

 6. src/components/tasks/KanbanBoardView.tsx

 - Add expandedParents state (Set<string>)
 - After each KanbanTaskCard with subtasks, conditionally render <ExpandedSubtasks>
 - Subtask cards render in column but indented

 7. src/components/tasks/SwimlaneTaskCard.tsx

 - Add SubtaskIndicator (same pattern as KanbanTaskCard)

 8. src/components/tasks/SwimlaneBoardView.tsx

 - Add expandedParents state + ExpandedSubtasks rendering (same pattern as KanbanBoardView)

 9. src/components/tasks/TaskRow.tsx

 - Add expand/collapse chevron toggle in title cell when subtaskCount > 0
 - Add onToggleSubtasks?, isExpanded?, isSubtask? props
 - When isSubtask: render with pl-8 indent on title cell

 10. src/components/tasks/BoardTable.tsx

 - Track expandedParents state
 - After expanded parent rows, render subtask TaskRow components via useSubtasks

 11. src/components/tasks/PersonalTaskCard.tsx

 - Add SubtaskIndicator for parent tasks
 - For subtasks: show parent context with CornerDownRight icon + parent title

 12. src/components/tasks/TaskModal.tsx

 - Add "Subtasks" tab after "Details" (only for top-level tasks where !task.parentTaskId):
   Tab trigger with ListTree icon, badge showing completedCount/totalCount
 - TabsContent renders <SubtasksTab> component
 - For subtasks: show "subtask of: Parent Title" breadcrumb at top of details
 - Clicking subtask row opens that subtask in TaskModal

 13. src/components/rollups/RollupTaskCard.tsx

 - Add SubtaskIndicator to meta row

 14. src/lib/actions/notifications.ts

 - createAssignmentNotification: when task has parentTaskId, include parent title:
   "assigned you to 'Subtask' (subtask of 'Parent')"
 - createDueNotification: same pattern for due/overdue messages
 - createCommentAddedNotification + createMentionNotification: include parent context

 ---
 Implementation Order

 1. src/lib/db/schema/tasks.ts - parentTaskId column + relations + generate migration
 2. src/lib/actions/tasks.ts - Update interfaces (TaskWithAssignees, CreateTaskInput, etc.)
 3. src/lib/actions/tasks.ts - listTasks filter + subtask counts
 4. src/lib/actions/tasks.ts - New listSubtasks function
 5. src/lib/actions/tasks.ts - createTask parentTaskId support
 6. src/lib/actions/tasks.ts - getTask, listMyTasks, searchTasks updates
 7. src/lib/hooks/useTasks.ts + index.ts - useSubtasks, useCreateSubtask, cache invalidation
 8. src/components/tasks/SubtaskIndicator.tsx - New component
 9. src/components/tasks/KanbanTaskCard.tsx, SwimlaneTaskCard.tsx, PersonalTaskCard.tsx,
    RollupTaskCard.tsx, TaskRow.tsx - Add SubtaskIndicator to all card variants
 10. src/components/tasks/ExpandedSubtasks.tsx - New component
 11. src/components/tasks/KanbanBoardView.tsx, SwimlaneBoardView.tsx, BoardTable.tsx -
     Expand/collapse state + ExpandedSubtasks rendering
 12. src/components/tasks/SubtasksTab.tsx - New component
 13. src/components/tasks/TaskModal.tsx - Subtasks tab + parent breadcrumb
 14. src/lib/actions/notifications.ts - Parent context in notification titles

 ---
 Key Reusable Existing Code
 What: Task creation
 Where: createTask() from src/lib/actions/tasks.ts:55-69
 How: CreateTaskInput type, add parentTaskId field
 ────────────────────────────────────────
 What: Task access check
 Where: canAccessTask() helper in src/lib/actions/tasks.ts
 How: Reuse for listSubtasks access validation
 ────────────────────────────────────────
 What: Board assignable users pattern
 Where: getBoardAssignableUsers() at src/lib/actions/tasks.ts:978
 How: Reuse in SubtasksTab for assignee picker
 ────────────────────────────────────────
 What: StatusSelect / StatusBadge components
 Where: src/components/tasks/StatusSelect.tsx, StatusBadge.tsx
 How: Reuse for subtask status in SubtasksTab rows
 ────────────────────────────────────────
 What: AssigneeAvatars component
 Where: src/components/tasks/AssigneePicker.tsx
 How: Reuse for subtask assignee display
 ────────────────────────────────────────
 What: DateDisplay component
 Where: src/components/tasks/DatePicker.tsx
 How: Reuse for subtask due date display
 ────────────────────────────────────────
 What: TaskActivityIndicators component
 Where: src/components/tasks/TaskActivityIndicators.tsx
 How: Style reference for SubtaskIndicator
 ────────────────────────────────────────
 What: Recurring task completion status check
 Where: src/lib/actions/tasks.ts:764 (status === 'complete' || 'done' pattern)
 How: Reuse pattern for determining subtaskCompletedCount
 ────────────────────────────────────────
 What: Notification creation functions
 Where: src/lib/actions/notifications.ts
 How: Add parentTaskId-aware title formatting
 ---
 Verification

 1. Create a task, open it, go to Subtasks tab, add 3 subtasks with different statuses/assignees/dates
 2. Close modal - parent card shows subtask progress indicator (e.g. "1/3")
 3. Click expand on parent card in kanban - subtask cards appear indented below
 4. Click a subtask card - opens in TaskModal, shows "subtask of: Parent Title" breadcrumb
 5. Verify subtask tab is NOT shown when viewing a subtask (single-level enforcement)
 6. Assign a subtask to yourself - verify it appears in My Tasks with parent context
 7. Set a due date on a subtask - verify due date notifications fire
 8. Delete parent task - verify all subtasks are cascade deleted
 9. Try creating a subtask of a subtask via action - verify it returns an error
 10. Expand/collapse works in kanban, swimlane, and table views
 11. Search finds subtasks and shows parent task context
 12. Notifications for subtask assignment/due dates include parent context

 ---
 Recurring + Subtasks Interaction Plan

 Overview

 When a parent task is recurring and has subtasks, three behaviors apply:
 1. Completing a parent task with incomplete subtasks → confirm with user, then mark subtasks complete
 2. Recurring parent creates next instance → clone all subtasks to the new instance
 3. Subtasks cannot independently recur — their lifecycle is tied to the parent

 Design Decisions:
 - Subtasks are NOT allowed to have their own recurringConfig (enforced server-side)
 - When parent is completed, user gets a confirmation dialog if there are incomplete subtasks
 - Cloned subtasks in the next recurring instance start in default (first) status
 - Subtask due dates are cloned using relative offset from parent due date
   (e.g. subtask due 5 days before parent → same offset on new instance)
 - Subtasks with no due date are cloned without one
 - Cloned subtasks copy: title, description, section, assignees, position order, relative due dates
 - Cloned subtasks do NOT copy: comments, attachments, activity history
 - Auto-completing subtasks (via parent completion) does NOT send individual notifications
 - Newly cloned subtasks in next recurring instance DO send assignment notifications
 - Cascade delete already works via FK constraint — no changes needed for delete flows

 ---
 Modified Files

 1. src/lib/actions/tasks.ts — createTask()

 - Reject recurringConfig on subtasks: if parentTaskId is provided and recurringConfig is set,
   return { success: false, error: 'Subtasks cannot have recurring configuration' }

 2. src/lib/actions/tasks.ts — updateTask()

 - Reject setting recurringConfig on subtasks (same validation as createTask)
 - Accept new field: completeSubtasks?: boolean
 - When parent task is being marked complete/done AND completeSubtasks is true:
   batch-update all subtask statuses to the same complete status as the parent
   (UPDATE tasks SET status = :completeStatus WHERE parent_task_id = :parentId)
 - This must happen before the Inngest recurring event fires

 3. src/lib/validations/task.ts (or inline in actions)

 - Add completeSubtasks: z.boolean().optional() to the update task schema

 4. src/lib/inngest/functions/create-next-recurring-task.ts

 Add steps after assignee creation:

 - Step 7 "query-subtasks": Query all subtasks of the completed parent task
   SELECT * FROM tasks WHERE parent_task_id = :completedTaskId ORDER BY position ASC
 - Step 8 "clone-subtasks": For each subtask, insert a new task linked to newTask.id:
   - Same title, description, section, position
   - Default status (first status from board, same as parent gets)
   - Relative due date: if subtask had a dueDate AND parent had a dueDate,
     calculate offset = subtaskDueDate - parentDueDate, then newSubtaskDueDate = newParentDueDate + offset
   - parentTaskId = newTask.id (the newly created recurring parent)
   - No recurringConfig, no recurringGroupId (subtasks don't recur independently)
 - Step 9 "clone-subtask-assignees": Batch-query assignees for all original subtasks,
   then batch-insert assignees for all cloned subtasks

 No changes needed to src/lib/inngest/events.ts — the function already has taskId
 and can query subtasks directly from the database.

 5. src/lib/hooks/useTasks.ts — useUpdateTask

 - Accept and pass through the completeSubtasks flag to the updateTask server action
 - Optimistic update: when completeSubtasks is true, also update subtask query cache
   to show all subtasks as complete

 6. New: src/components/tasks/CompleteParentDialog.tsx

 Confirmation dialog shown when user tries to complete a parent task with incomplete subtasks.
 - Props: open, onOpenChange, incompleteCount, onConfirm(completeSubtasks: boolean)
 - Content: "This task has {incompleteCount} incomplete subtasks. Would you like to mark them
   as complete too?"
 - Three actions:
   - "Complete all" → onConfirm(true) — completes parent + all subtasks
   - "Just this task" → onConfirm(false) — completes only the parent
   - "Cancel" → onOpenChange(false) — cancels the status change entirely

 7. Status change integration points (all need CompleteParentDialog)

 Each of these components triggers status changes and needs to intercept completion
 of parent tasks with incomplete subtasks:

 a. src/components/tasks/TaskModal.tsx
    - StatusSelect onChange handler: check if task is parent with incomplete subtasks
      moving to complete status → show CompleteParentDialog before calling updateTask

 b. src/components/tasks/KanbanBoardView.tsx
    - DnD onDragEnd handler: when dropping a parent task into a "done/complete" column,
      intercept and show CompleteParentDialog before committing the move

 c. src/components/tasks/SwimlaneBoardView.tsx
    - Same DnD intercept as KanbanBoardView

 d. src/components/tasks/BoardTable.tsx / TaskRow.tsx
    - StatusSelect in table rows: same intercept pattern as TaskModal

 e. src/components/tasks/SubtasksTab.tsx
    - Not needed here (subtask status changes don't trigger this — subtasks can't have sub-subtasks)

 Helper: isCompleteStatus(statusId, boardStatusOptions) utility function
 to centralize the "complete"/"done" status detection logic used in multiple places.

 ---
 Edge Cases & Obstacles

 1. DnD intercept complexity: Kanban drag-and-drop to a "Done" column currently commits
    immediately. Need to make the handler async — store a "pending drop" state, show the
    dialog, then commit or revert based on user choice.

 2. Subtask due date edge cases:
    - Parent has no dueDate but subtask does → clone subtask with no due date (can't calculate offset)
    - Offset would place subtask due date in the past → still use the offset (user can adjust)
    - Subtask due date is AFTER parent due date → positive offset, still works

 3. Recurring series edits (updateRecurringSeries): Currently updates title, description,
    section, assignees on all future instances. Does NOT need to touch subtasks — each
    instance's subtasks are independent snapshots. But worth noting this is a conscious choice.

 4. "Edit all future occurrences" flow: Does not affect subtasks of future instances.
    Each instance gets its subtasks cloned fresh when created. Only the current instance's
    subtasks are editable directly.

 5. Performance: A parent with many subtasks (e.g. 20+) means the Inngest function does
    20+ inserts. Should batch-insert subtasks and assignees in single queries, not loops.

 6. What if parent is completed but dialog is dismissed (Cancel)?
    The status change should NOT be applied. The StatusSelect/DnD handler must wait for
    dialog resolution before calling updateTask.

 ---
 Implementation Order

 1. src/lib/actions/tasks.ts — Reject recurringConfig on subtasks (createTask + updateTask)
 2. src/lib/actions/tasks.ts — Add completeSubtasks flag to updateTask, batch-complete subtasks
 3. src/lib/inngest/functions/create-next-recurring-task.ts — Clone subtasks + assignees
 4. src/lib/hooks/useTasks.ts — Pass completeSubtasks, optimistic updates
 5. src/components/tasks/CompleteParentDialog.tsx — New confirmation dialog
 6. Utility: isCompleteStatus() helper (extract from repeated inline logic)
 7. src/components/tasks/TaskModal.tsx — Intercept status change with dialog
 8. src/components/tasks/KanbanBoardView.tsx — Intercept DnD with dialog
 9. src/components/tasks/SwimlaneBoardView.tsx — Intercept DnD with dialog
 10. src/components/tasks/BoardTable.tsx / TaskRow.tsx — Intercept status change with dialog

 ---
 Verification

 1. Create a recurring parent task with 3 subtasks (different statuses/assignees/due dates)
 2. Mark parent as "Done" → confirmation dialog appears showing 2 incomplete subtasks
 3. Choose "Complete all" → parent + all subtasks marked done
 4. Verify next recurring instance is created with all 3 subtasks cloned:
    - Subtasks have default status (not "done")
    - Subtask assignees match originals
    - Subtask due dates have correct relative offset from new parent due date
 5. On the new instance, complete parent with "Just this task" → only parent completes,
    subtasks remain in their current status
 6. Cancel the dialog → status change is reverted, nothing changes
 7. Drag parent task to "Done" column in kanban → dialog appears, same behavior
 8. Verify subtasks cannot have recurringConfig set (rejected by server action)
 9. Verify cloned subtasks have no comments/attachments (fresh instances)
 10. Verify assignment notifications fire for cloned subtask assignees
 11. Verify auto-completed subtasks do NOT generate individual notifications
 12. Delete a recurring parent → cascade deletes subtasks (existing behavior, just verify)

 ---

 Front Integration - Implementation Plan

 Overview

 Add Front inbox integration to Central. Two core features:
 1. Link Front conversations to tasks — attach conversations to tasks, view messages inline, keep status synced via webhooks
 2. Reply to Front from Central — when commenting on a task with linked conversations, optionally send the comment as a Front reply

 Front connection uses an API token (admin pastes it in Settings > Integrations). Conversations appear in a new
 "Conversations" tab in TaskModal. Webhook endpoint keeps linked conversations in sync (new messages, status changes).

 Design Decisions:
 - API token auth (not OAuth) — admin configures once, org-wide token
 - Org-level connection — single front_connections row, not per-user
 - New "Conversations" tab in TaskModal (alongside Details/Subtasks/Attachments)
 - Webhook sync in v1 — Front POSTs events to /api/webhooks/front, processed via Inngest
 - Conversation linking by URL — user pastes a Front conversation URL, we parse the conversation ID
 - Reply opt-in — toggle in comment composer, default off, explicit per-comment
 - Author mapping — use author_id: "alt:email:user@domain.com" so replies appear from the correct Front teammate
 - Tiptap to HTML — use @tiptap/html generateHTML() to convert comment content for Front's message body
 - HMAC webhook validation — verify x-front-signature header against a signing secret

 ---
 New Files (8)

 1. src/lib/db/schema/front.ts

 Two tables:

 front_connections (org-level, single row):
 - id: uuid PK
 - apiToken: text NOT NULL
 - webhookSecret: text (for HMAC validation of incoming webhooks)
 - connectedAt: timestamp
 - updatedAt: timestamp

 front_conversations (links conversations to tasks):
 - id: uuid PK
 - taskId: uuid FK → tasks.id (cascade delete)
 - conversationId: varchar NOT NULL (Front's "cnv_xxx" ID)
 - subject: varchar (cached from Front)
 - status: varchar (open/archived/etc)
 - lastMessageAt: timestamp (for freshness display)
 - messageCount: integer (cached count)
 - linkedBy: uuid FK → users.id (set null on delete)
 - createdAt: timestamp
 Unique constraint on (taskId, conversationId) to prevent duplicate links.

 2. src/lib/front/client.ts

 Front API client. Functions:
 - getFrontConnection(): query front_connections table, return token or null
 - frontApi(path, options): wrapper around fetch with Authorization: Bearer {token},
   base URL https://api2.frontapp.com
 - getConversation(conversationId): GET /conversations/{id}, returns subject, status,
   assignee, tags, last_message timestamp
 - getConversationMessages(conversationId, limit?): GET /conversations/{id}/messages,
   returns message list (sender, body, timestamp)
 - sendReply(conversationId, body, authorEmail?): POST /conversations/{id}/messages,
   sends HTML body, optional author_id via alt:email:{email}
 - parseConversationUrl(url): extract conversation ID from Front URL
   (format: https://app.frontapp.com/open/cnv_xxx or just cnv_xxx)
 - validateWebhookSignature(payload, signature, timestamp, secret): HMAC-SHA256 verification

 3. src/lib/actions/front.ts

 Server actions:
 - getFrontConnectionStatus(): returns { connected: boolean }
 - saveFrontConnection(input: { apiToken: string }): upsert front_connections row,
   test token with GET /me endpoint, return success/error
 - disconnectFront(): delete front_connections row + all front_conversations rows
 - linkConversation(taskId, conversationUrl): parse URL → call getConversation() to validate +
   fetch metadata → insert front_conversations row → return conversation data
 - unlinkConversation(frontConversationId): delete from front_conversations
 - getTaskConversations(taskId): query front_conversations WHERE taskId,
   ordered by lastMessageAt desc
 - getConversationMessages(frontConversationId): look up conversationId →
   call Front API → return formatted messages
 - sendFrontReply(taskId, htmlBody, authorEmail): query all linked conversations for task →
   send reply to each → return results

 4. src/lib/hooks/useFront.ts

 React Query hooks:
 frontKeys = {
   all: ['front'],
   connection: () => ['front', 'connection'],
   conversations: (taskId) => ['front', 'conversations', taskId],
   messages: (conversationId) => ['front', 'messages', conversationId],
 }
 - useFrontConnection(): query connection status
 - useTaskConversations(taskId, options?): query linked conversations for a task
 - useConversationMessages(conversationId, options?): query messages for expanded conversation
 - useLinkConversation(): mutation, invalidates conversations cache
 - useUnlinkConversation(): mutation, invalidates conversations cache
 - useSendFrontReply(): mutation for manual reply (from Conversations tab)
 - useSaveFrontConnection(): mutation for settings page
 - useDisconnectFront(): mutation for settings page

 5. src/components/front/FrontConnectionCard.tsx

 Settings page component (follows CalendarConnectionCard pattern):
 - Shows connection status (connected/not connected)
 - Not connected: input field for API token + "Connect" button
   - On submit: calls saveFrontConnection(), tests token validity
   - Shows error if token is invalid
 - Connected: green badge, "Disconnect" button with confirmation dialog
 - Webhook URL display: shows the URL to configure in Front
   ({APP_URL}/api/webhooks/front) with copy button

 6. src/components/tasks/ConversationsTab.tsx

 New TaskModal tab component.
 Props: taskId, currentUser

 Sections:
 - Linked conversations list: each row shows:
   - Mail icon + subject line (bold)
   - Status badge (open/archived)
   - "Last message: 2h ago" timestamp
   - Expand/collapse chevron → shows recent messages inline
   - "Open in Front" external link button
   - Unlink (X) button on hover
 - Expanded messages view: when a conversation is expanded:
   - List of recent messages (most recent first, capped at ~10)
   - Each message: sender name, timestamp, body (rendered HTML)
   - "View all in Front" link at bottom
 - Reply form (at bottom of expanded conversation):
   - Simple textarea + "Send reply" button
   - Sends via sendFrontReply() action
   - Success toast, refreshes messages
 - Link conversation form at bottom:
   - Text input: "Paste a Front conversation URL..."
   - "Link" button
   - Validates URL format, calls linkConversation()
 - Empty state: MessageSquare icon + "No linked conversations" + link form

 7. src/app/api/webhooks/front/route.ts

 Webhook endpoint for Front events:
 - POST handler
 - Validate x-front-signature HMAC header against stored webhook secret
 - Parse event payload: { type, conversation, ... }
 - For relevant event types (inbound, out_reply, archive, reopen, trash, restore):
   - Look up conversation ID in front_conversations table
   - If found: send Inngest event front/conversation.updated
 - Return 200 immediately (processing happens async in Inngest)

 8. src/lib/inngest/functions/sync-front-conversation.ts

 Inngest function triggered by front/conversation.updated:
 - Step 1 "fetch-conversation": Call Front API to get updated conversation data
   (subject, status, last_message_at)
 - Step 2 "update-record": Update front_conversations row with new data
 - Step 3 "notify-if-needed": If event is inbound (new message received),
   create in-app notification for task assignees:
   "New message on '{subject}' (linked to '{taskTitle}')"

 ---
 Modified Files (12)

 1. src/lib/db/schema/index.ts

 - Add: export * from './front'

 2. drizzle/ — Migration file

 - Generated by drizzle-kit generate. Creates front_connections and front_conversations tables.

 3. src/lib/inngest/events.ts

 - Add FrontConversationUpdatedEvent interface:
   name: 'front/conversation.updated'
   data: { conversationId, eventType, frontConversationDbId }
 - Add to NotificationEvent union type

 4. src/lib/inngest/functions/index.ts

 - Add: export { syncFrontConversation } from './sync-front-conversation'

 5. src/app/api/inngest/route.ts

 - Import and register syncFrontConversation in the functions array

 6. src/lib/hooks/index.ts

 - Export all hooks from ./useFront

 7. src/components/tasks/TaskModal.tsx

 - Import ConversationsTab and MessageSquare icon
 - Add "Conversations" tab trigger after Subtasks (conditional: !isNew && task):
   TabsTrigger with MessageSquare icon, badge showing conversation count
 - Add TabsContent rendering <ConversationsTab taskId={task.id} currentUser={currentUser} />
 - Add useTaskConversations(task?.id) hook call to get conversation count for badge
 - Add useFrontConnection() to conditionally show the tab only when Front is connected

 8. src/app/(dashboard)/settings/integrations/page.tsx

 - Import and render <FrontConnectionCard /> below <CalendarConnectionCard />

 9. src/lib/actions/comments.ts — createComment()

 - Accept new optional field: sendToFront?: boolean
 - After comment is created and notifications fire:
   - If sendToFront is true, query front_conversations for the task
   - Convert TiptapContent to HTML using generateHTML() from @tiptap/html
   - For each linked conversation, call sendReply() from the Front client
   - Fire-and-forget pattern (same as notification sends)

 10. src/components/comments/CommentsSection.tsx

 - Accept new prop: hasFrontConversations?: boolean
 - Pass to <CommentEditor hasFrontConversations={hasFrontConversations} />
 - Update handleSubmit to pass sendToFront flag to createComment

 11. src/components/comments/CommentEditor.tsx

 - Accept new prop: hasFrontConversations?: boolean
 - Add state: sendToFront (boolean, default false)
 - In footer bar (next to "Attach file" button), when hasFrontConversations:
   "Reply in Front" toggle button (ghost variant, bg-muted when active)
 - Update onSubmit signature to pass sendToFront boolean
 - Reset sendToFront to false after submission

 12. src/lib/hooks/useComments.ts — useCreateComment()

 - Update CreateCommentInput usage to include sendToFront?: boolean
 - Pass through to server action

 ---
 Implementation Order

 1. src/lib/db/schema/front.ts — New schema: front_connections + front_conversations tables
 2. src/lib/db/schema/index.ts — Export new schema
 3. drizzle/ — Generate + run migration
 4. src/lib/front/client.ts — Front API client (fetch wrapper, conversation endpoints, URL parser, webhook validation)
 5. src/lib/actions/front.ts — Server actions (connect, disconnect, link, unlink, get conversations, get messages, send reply)
 6. src/lib/hooks/useFront.ts — React Query hooks for Front data
 7. src/lib/hooks/index.ts — Export new hooks
 8. src/components/front/FrontConnectionCard.tsx — Settings page connection card
 9. src/app/(dashboard)/settings/integrations/page.tsx — Add FrontConnectionCard to integrations page
 10. src/components/tasks/ConversationsTab.tsx — New TaskModal tab with conversation list, messages, link form, reply form
 11. src/components/tasks/TaskModal.tsx — Add Conversations tab trigger + content
 12. src/lib/inngest/events.ts — Add FrontConversationUpdatedEvent type
 13. src/lib/inngest/functions/sync-front-conversation.ts — Inngest function for webhook-triggered sync
 14. src/lib/inngest/functions/index.ts — Export new function
 15. src/app/api/inngest/route.ts — Register new function
 16. src/app/api/webhooks/front/route.ts — Webhook endpoint for Front events
 17. src/lib/actions/comments.ts — Add sendToFront support to createComment
 18. src/lib/hooks/useComments.ts — Pass sendToFront through mutation
 19. src/components/comments/CommentEditor.tsx — "Reply in Front" toggle button
 20. src/components/comments/CommentsSection.tsx — Pass hasFrontConversations prop, wire sendToFront

 ---
 Key Reusable Existing Code
 What: CalendarConnectionCard pattern
 Where: src/components/calendar/CalendarConnectionCard.tsx
 How: Template for FrontConnectionCard (connection status, disconnect dialog, toast on connect)
 ────────────────────────────────────────
 What: Google Calendar token storage
 Where: src/lib/db/schema/google-calendar.ts
 How: Schema pattern for front_connections table
 ────────────────────────────────────────
 What: Inngest event + function pattern
 Where: src/lib/inngest/events.ts + functions/send-*-slack-notification.ts
 How: Template for FrontConversationUpdatedEvent + sync function
 ────────────────────────────────────────
 What: Inngest function registration
 Where: src/app/api/inngest/route.ts
 How: Add new function to serve()
 ────────────────────────────────────────
 What: CommentEditor footer toggle
 Where: src/components/comments/CommentEditor.tsx:209-219
 How: "Attach file" button pattern for "Reply in Front" toggle
 ────────────────────────────────────────
 What: CommentsSection submit flow
 Where: src/components/comments/CommentsSection.tsx:53-67
 How: Where to wire sendToFront into createComment
 ────────────────────────────────────────
 What: TaskModal tab pattern
 Where: src/components/tasks/TaskModal.tsx:477-498
 How: How tabs are structured (TabsList/TabsTrigger/TabsContent)
 ────────────────────────────────────────
 What: SubtasksTab conditional rendering
 Where: src/components/tasks/TaskModal.tsx:488-498
 How: Pattern for conditionally showing tab based on task state
 ────────────────────────────────────────
 What: Schema index barrel exports
 Where: src/lib/db/schema/index.ts
 How: Add front schema export
 ────────────────────────────────────────
 What: Hooks index barrel exports
 Where: src/lib/hooks/index.ts
 How: Add front hooks export
 ────────────────────────────────────────
 What: React Query key factory
 Where: src/lib/hooks/useGoogleCalendar.ts (calendarKeys)
 How: Pattern for frontKeys
 ────────────────────────────────────────
 What: Server action auth pattern
 Where: src/lib/actions/google-calendar.ts
 How: requireAuth() + connection check pattern
 ────────────────────────────────────────
 What: Fire-and-forget notification pattern
 Where: src/lib/actions/comments.ts (createComment)
 How: Pattern for async Front reply sends
 ────────────────────────────────────────
 What: Integrations settings page
 Where: src/app/(dashboard)/settings/integrations/page.tsx
 How: Where to add FrontConnectionCard

 ---
 Dependencies

 - @tiptap/html: for generateHTML() to convert TiptapContent to HTML for Front replies.
   Check if already installed; if not, npm install @tiptap/html.

 ---
 Environment Variables

 FRONT_WEBHOOK_SECRET — secret for validating Front webhook signatures (env-based, set once)

 Note: The API token is stored in the DB (front_connections table) via the settings UI, not as an env var.

 ---
 Verification

 1. Settings: Go to Settings > Integrations, paste a Front API token, verify it connects (tests with GET /me)
 2. Link conversation: Open a task, go to Conversations tab, paste a Front conversation URL,
    verify it links and shows subject/status/last message time
 3. View messages: Expand a linked conversation, verify recent messages display with sender, timestamp, body
 4. Reply from Conversations tab: Type a reply in the expanded conversation's reply form,
    verify it appears in Front
 5. Reply from comment: Post a comment with "Reply in Front" toggled on, verify the comment content
    appears as a reply in the linked Front conversation(s)
 6. Webhook sync: Send a message to a linked conversation in Front, verify Central updates
    lastMessageAt and shows the new message
 7. Webhook signature validation: Send a request with invalid signature to /api/webhooks/front,
    verify 401 rejection
 8. Unlink: Unlink a conversation from a task, verify it's removed from the Conversations tab
 9. Cascade delete: Delete a task with linked conversations, verify front_conversations rows are deleted
 10. Disconnect: Disconnect Front in settings, verify all front_conversations are cleaned up
 11. Tab visibility: Verify Conversations tab only appears when Front is connected
 12. Empty state: Open Conversations tab on a task with no linked conversations, verify link form is shown
